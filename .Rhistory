row <- map[year == y]
if (!nrow(row)) return(NULL)
fam_vars <- unlist(row[, ..fam_cols], use.names = FALSE)
out <- load_wave(y, fam_vars, "FAMILY")
if (!is.null(out)) attr(out, "map_row") <- row
out
})
fam <- rbindlist(fam_list, fill = TRUE)
if (!nrow(fam)) stop("Loaded 0 rows for FAMILY; verify psid_dir and your CSV ER codes.")
psid_dir <- "C:/Users/frost01/Documents/PSIDdata"   # <-- CHANGE THIS to where you unzipped the PSID files
# quick sanity checks
stopifnot(dir.exists(psid_dir))
set.psid.path(psid_dir)
psid_dir <- "C:/Users/frost01/Documents/PSIDdata"
stopifnot(dir.exists(psid_dir))
# choose years (odd years)
years <- seq(2001, 2021, by = 2)
# You need to supply fam.vars as a data.frame listing the variables you want
# Example (you’d fill this with actual variable names you care about)
fam.vars <- data.frame(
year = years,
# new_name = variable_name_in_that_wave
faminc = c("ER24099", "ER25000", NA, ... )  # fill out etc
)
suppressPackageStartupMessages({
library(psidR)
library(data.table)
})
psid_dir <- "C:/Users/frost01/Documents/PSIDdata"   # <- folder with UNZIPPED .dta/.sas7bdat files
stopifnot(dir.exists(psid_dir))
# Pick years (odd years only as you discussed)
years <- seq(2001, 2021, by = 2)
# Call signature can vary by psidR version; handle both cases:
bp_formals <- names(formals(psidR::build.panel))
if ("datadir" %in% bp_formals) {
fam_year <- psidR::build.panel(
ind    = FALSE,
fam    = TRUE,
heads  = TRUE,
years  = years,
datadir = psid_dir
)
fi_long <- psidR::build.panel(
ind    = TRUE,
fam    = TRUE,
heads  = TRUE,
years  = years,
datadir = psid_dir
)
} else {
# Some versions read a global option instead of a datadir arg
options(psidR.datadir = psid_dir)
fam_year <- psidR::build.panel(
ind    = FALSE,
fam    = TRUE,
heads  = TRUE,
years  = years
)
fi_long <- psidR::build.panel(
ind    = TRUE,
fam    = TRUE,
heads  = TRUE,
years  = years
)
}
psid_dir <- "C:/Users/frost01/Documents/PSIDdata"       # <-- change if needed
stopifnot(dir.exists(psid_dir))
# 2) load your CSV of ER codes (the one you filled)
map_csv <- "C:/Users/frost01/Documents/Fill_this_with_ER_variable_numbers_by_wave__save_and_reupload_if_you_edit_locally__.csv"
stopifnot(file.exists(map_csv))
map <- fread(map_csv)
# optional: only odd years
# map <- map[year %% 2 == 1]
# 3) construct fam.vars and ind.vars in the format build.panel() expects:
#    - one row per year
#    - each column is a variable “name” you want in the output
#    - each cell is the *ER variable name for that wave* (character string)
norm_na <- function(x) { x[is.na(x)] <- ""; x }
# choose which columns to pull from FAMILY and IND files (rename on the left to your desired output names)
fam_vars <- data.frame(
year      = map$year,
interview = norm_na(map$ER_interview_num),        # REQUIRED to join across files reliably
faminc    = norm_na(map$ER_total_family_income),  # example: total family income
release   = norm_na(map$ER_release_num),          # optional
hh_id     = norm_na(map$ER_household_ID),         # optional
seqnum    = norm_na(map$ER_sequence_num),         # optional
stringsAsFactors = FALSE
)
# drop columns that are entirely blank (no ER specified for any year)
fam_vars <- fam_vars[, colSums(fam_vars != "") > 0, drop = FALSE]
# IND file selections (optional but useful if you’ll make a person-level panel later)
ind_vars <- data.frame(
year        = map$year,
rel_to_head = norm_na(map$ER_relation_to_head),   # relation code
age         = norm_na(map$ER_age),                # age
# weights or person id can be added if you know ER codes per year:
# perid1968   = norm_na(map$ER_perid1968),        # DON'T include ER30001/ER30002 here (psidR warns against including id vars)
stringsAsFactors = FALSE
)
ind_vars <- ind_vars[, colSums(ind_vars != "") > 0, drop = FALSE]
# sanity: do we have at least 'year' + one non-empty fam var?
if (!("year" %in% names(fam_vars)) || ncol(fam_vars) < 2) {
stop("fam.vars has no usable variables (only 'year'). Fill ER codes in your CSV for at least 'ER_interview_num' and one data field.")
}
# 4) build family–year (heads.only=TRUE keeps head/RefPerson rows when merging logic applies)
fam_year <- psidR::build.panel(
datadir     = psid_dir,
fam.vars    = fam_vars,
ind.vars    = NULL,          # family-year only
heads.only  = TRUE,
design      = "all"          # keep all observed heads across years
)
psid_dir <- "C:/Users/frost01/Documents/PSIDdata"       # <-- change if needed
stopifnot(dir.exists(psid_dir))
# 2) load your CSV of ER codes (the one you filled)
map_csv <- "C:/Users/frost01/Documents/Fill_this_with_ER_variable_numbers_by_wave__save_and_reupload_if_you_edit_locally__.csv"
stopifnot(file.exists(map_csv))
map <- fread(map_csv)
# optional: only odd years
# map <- map[year %% 2 == 1]
# 3) construct fam.vars and ind.vars in the format build.panel() expects:
#    - one row per year
#    - each column is a variable “name” you want in the output
#    - each cell is the *ER variable name for that wave* (character string)
norm_na <- function(x) { x[is.na(x)] <- ""; x }
# choose which columns to pull from FAMILY and IND files (rename on the left to your desired output names)
fam_vars <- data.frame(
year      = map$year,
interview = norm_na(map$ER_interview_num),        # REQUIRED to join across files reliably
faminc    = norm_na(map$ER_total_family_income),  # example: total family income
release   = norm_na(map$ER_release_num),          # optional
hh_id     = norm_na(map$ER_household_ID),         # optional
seqnum    = norm_na(map$ER_sequence_num),         # optional
stringsAsFactors = FALSE
)
# drop columns that are entirely blank (no ER specified for any year)
fam_vars <- fam_vars[, colSums(fam_vars != "") > 0, drop = FALSE]
# IND file selections (optional but useful if you’ll make a person-level panel later)
ind_vars <- data.frame(
year        = map$year,
rel_to_head = norm_na(map$ER_relation_to_head),   # relation code
age         = norm_na(map$ER_age),                # age
# weights or person id can be added if you know ER codes per year:
# perid1968   = norm_na(map$ER_perid1968),        # DON'T include ER30001/ER30002 here (psidR warns against including id vars)
stringsAsFactors = FALSE
)
ind_vars <- ind_vars[, colSums(ind_vars != "") > 0, drop = FALSE]
# sanity: do we have at least 'year' + one non-empty fam var?
if (!("year" %in% names(fam_vars)) || ncol(fam_vars) < 2) {
stop("fam.vars has no usable variables (only 'year'). Fill ER codes in your CSV for at least 'ER_interview_num' and one data field.")
}
# 4) build family–year (heads.only=TRUE keeps head/RefPerson rows when merging logic applies)
fam_year <- psidR::build.panel(
datadir     = psid_dir,
fam.vars    = fam_vars,
ind.vars    = NULL,          # family-year only
heads.only  = TRUE,
design      = "all"          # keep all observed heads across years
)
map_csv  <- "C:/Users/frost01/Documents/Fill_this_with_ER_variable_numbers_by_wave__save_and_reupload_if_you_edit_locally__.csv"
# ---- sanity checks
if (!dir.exists(psid_dir)) stop("psid_dir doesn't exist: ", psid_dir)
if (!file.exists(map_csv)) stop("Crosswalk CSV not found: ", map_csv)
# ---- read mapping (must include at least: year, ER_famid1968 or ER_interview_num)
map <- fread(map_csv)
if (!"year" %in% names(map)) stop("Your CSV must have a 'year' column.")
# If you only want odd-year panel, uncomment next line:
# map <- map[year %% 2 == 1]
years <- sort(unique(map$year))
# ---- helper: fuzzy file finder (no fixed folder structure required)
find_file <- function(year, kind = c("FAMILY","IND")) {
kind <- match.arg(kind)
if (!dir.exists(psid_dir)) return(NA_character_)
# Look for family vs individual files; accept both .dta and .sas7bdat
pat_base <- if (kind == "FAMILY") "(FAM|FAMILY)" else "(IND|INDIV)"
# prioritize year in filename
all <- list.files(psid_dir, pattern = "\\.(dta|sas7bdat)$", full.names = TRUE,
ignore.case = TRUE, recursive = TRUE)
cand <- grep(pat_base, all, ignore.case = TRUE, value = TRUE)
# prefer those that include the 4-digit year
cand_year <- grep(sprintf("%d", year), cand, value = TRUE)
pick <- if (length(cand_year)) cand_year else cand
if (!length(pick)) return(NA_character_)
pick[1]
}
# ---- loader that selects only the ER codes provided for that year
load_wave <- function(year, er_vars, kind = c("FAMILY","IND")) {
kind <- match.arg(kind)
f <- find_file(year, kind)
if (is.na(f)) {
warning(sprintf("%s file missing for %s (search under: %s)", kind, year, psid_dir))
return(NULL)
}
dt <- if (grepl("\\.dta$", f, ignore.case = TRUE)) read_dta(f) else read_sas(f)
setDT(dt)
# Select strictly by ER names; ignore blanks/missing from the CSV
keep <- er_vars[er_vars != "" & !is.na(er_vars)]
keep <- intersect(keep, names(dt))
if (!length(keep)) {
warning(sprintf("No requested ER variables found in %s %s (file: %s)", kind, year, basename(f)))
return(NULL)
}
out <- dt[, ..keep]
out[, year := year]
attr(out, "source_file") <- f
out
}
# ---- columns expected in your CSV (names can be different, but these are assumed below)
# FAMILY-level candidates
fam_cols <- c("ER_release_num", "ER_total_family_income", "ER_household_ID",
"ER_interview_num", "ER_sequence_num", "ER_famid1968")
need_any_fam_key <- c("ER_famid1968", "ER_interview_num")
# INDIVIDUAL-level candidates
ind_cols <- c("ER_relation_to_head", "ER_age", "ER_perid1968", "ER_famid1968", "ER_interview_num")
# ---- build FAMILY by year
fam_list <- lapply(years, function(y) {
row <- map[year == y]
if (!nrow(row)) return(NULL)
fam_vars <- unlist(row[, ..fam_cols], use.names = FALSE)
out <- load_wave(y, fam_vars, "FAMILY")
if (!is.null(out)) attr(out, "map_row") <- row
out
})
fam <- rbindlist(fam_list, fill = TRUE)
if (!nrow(fam)) stop("Loaded 0 rows for FAMILY; verify psid_dir and your CSV ER codes.")
setwd('C:/Users/frost01/Documents/PSIDdata')
#install.packages("readxl")
library(readxl)
#install.packages('psidR')
library(psidR)
#install.packages('devtools')
library(devtools)
#install.packages("data.table")
library(data.table)
psid_dir <- "C:/Users/frost01/Documents/PSIDdata"       # <-- change if needed
stopifnot(dir.exists(psid_dir))
# 2) load your CSV of ER codes (the one you filled)
map_csv <- "C:/Users/frost01/Documents/Fill_this_with_ER_variable_numbers_by_wave__save_and_reupload_if_you_edit_locally__.csv"
stopifnot(file.exists(map_csv))
map_csv <- "C:/Users/frost01/Documents/Fill_this_with_ER_variable_numbers_by_wave__save_and_reupload_if_you_edit_locally__.csv"
map_csv <- "C:/Users/frost01/Documents/PSIDdata/Fill_this_with_ER_variable_numbers_by_wave__save_and_reupload_if_you_edit_locally__.csv"
stopifnot(file.exists(map_csv))
map <- fread(map_csv)
psid_dir <- "C:/Users/frost01/Documents/PSIDdata"       # <-- change if needed
stopifnot(dir.exists(psid_dir))
# 2) load your CSV of ER codes (the one you filled)
map_csv <- "C:/Users/frost01/Documents/PSIDdata/Fill_this_with_ER_variable_numbers_by_wave__save_and_reupload_if_you_edit_locally__.csv"
stopifnot(file.exists(map_csv))
map <- fread(map_csv)
map <- map[year %% 2 == 1]
norm_na <- function(x) { x[is.na(x)] <- ""; x }
View(fam_list)
View(ind)
View(ind_list)
View(ind_vars)
map_csv <- "C:/Users/frost01/Documents/PSIDdata/Fill_this_with_ER_variable_numbers_by_wave__save_and_reupload_if_you_edit_locally__.csv"
stopifnot(file.exists(map_csv))
map <- fread(map_csv)
map <- map[year %% 2 == 1]
# 3) construct fam.vars and ind.vars in the format build.panel() expects:
# one row per year
#each column is a variable “name” you want in the output
# each cell is the *ER variable name for that wave
norm_na <- function(x) { x[is.na(x)] <- ""; x }
fam_vars <- data.frame(
year      = map$year,
interview = norm_na(map$ER_interview_num),        # REQUIRED to join across files reliably
faminc    = norm_na(map$ER_total_family_income),  # example: total family income
release   = norm_na(map$ER_release_num),          # optional
hh_id     = norm_na(map$ER_household_ID),         # optional
seqnum    = norm_na(map$ER_sequence_num),         # optional
stringsAsFactors = FALSE
)
View(fam_vars)
fam_vars <- fam_vars[, colSums(fam_vars != "") > 0, drop = FALSE]
# IND file selections
ind_vars <- data.frame(
year        = map$year,
rel_to_head = norm_na(map$ER_relation_to_head),   # relation code
age         = norm_na(map$ER_age),                # age
stringsAsFactors = FALSE
)
View(ind_list)
ind_vars <- ind_vars[, colSums(ind_vars != "") > 0, drop = FALSE]
View(ind_vars)
if (!("year" %in% names(fam_vars)) || ncol(fam_vars) < 2) {
stop("fam.vars has no usable variables (only 'year'). Fill ER codes in your CSV for at least 'ER_interview_num' and one data field.")
}
fam_year <- psidR::build.panel(
datadir     = psid_dir,
fam.vars    = fam_vars,
ind.vars    = NULL,          # family-year only
heads.only  = TRUE,
design      = "all"          # keep all observed heads across years
)
yes
ind_vars <- ind_vars[, colSums(ind_vars != "") > 0, drop = FALSE]
if (!("year" %in% names(fam_vars)) || ncol(fam_vars) < 2) {
stop("fam.vars has no usable variables (only 'year'). Fill ER codes in your CSV for at least 'ER_interview_num' and one data field.")
}
fam_year <- psidR::build.panel(
datadir     = psid_dir,
fam.vars    = fam_vars,
ind.vars    = NULL,          # family-year only
heads.only  = TRUE,
design      = "all"          # keep all observed heads across years
)
psid_dir <- "C:/Users/frost01/Documents/PSIDdata"
dir.create(psid_dir, showWarnings = FALSE, recursive = TRUE)
# some psidR builds honor this to skip the prompt
options(psidR.auto.download = TRUE)
# try again; include download flag if your version supports it
fam_year <- psidR::build.panel(
datadir    = psid_dir,
fam.vars   = fam_vars,
ind.vars   = NULL,
heads.only = TRUE,
design     = "all",
download   = TRUE   # if your psidR has this arg
)
psid_dir <- "C:/Users/frost01/Documents/PSIDdata"
dir.create(psid_dir, showWarnings = FALSE, recursive = TRUE)
# some psidR builds honor this to skip the prompt
options(psidR.auto.download = TRUE)
# try again; include download flag if your version supports it
fam_year <- psidR::build.panel(
datadir    = psid_dir,
fam.vars   = fam_vars,
ind.vars   = NULL,
heads.only = TRUE,
design     = "all",
download   = TRUE   # if your psidR has this arg
fam_vars <- data.frame(
fam_vars <- data.frame(
year      = map$year,
interview = norm_na(map$ER_interview_num),        # REQUIRED to join across files reliably
faminc    = norm_na(map$ER_total_family_income),  # example: total family income
release   = norm_na(map$ER_release_num),          # optional
hh_id     = norm_na(map$ER_household_ID),         # optional
seqnum    = norm_na(map$ER_sequence_num),         # optional
stringsAsFactors = FALSE
)
fam_vars <- fam_vars[, colSums(fam_vars != "") > 0, drop = FALSE]
# IND file selections
ind_vars <- data.frame(
year        = map$year,
rel_to_head = norm_na(map$ER_relation_to_head),   # relation code
age         = norm_na(map$ER_age),                # age
stringsAsFactors = FALSE
)
ind_vars <- ind_vars[, colSums(ind_vars != "") > 0, drop = FALSE]
if (!("year" %in% names(fam_vars)) || ncol(fam_vars) < 2) {
stop("fam.vars has no usable variables (only 'year'). Fill ER codes in your CSV for at least 'ER_interview_num' and one data field.")
}
fam_year <- psidR::build.panel(
datadir     = psid_dir,
fam.vars    = fam_vars,
ind.vars    = NULL,          # family-year only
heads.only  = TRUE,
design      = "all"          # keep all observed heads across years
)
intall.packages"psidR"
intall.packages("psidR")
install.packages("psidR")
years_needed <- unique(fam_vars$year)
fam_year <- psidR::build.panel(
datadir    = psid_dir,
fam.vars   = fam_vars,
ind.vars   = NULL,
heads.only = TRUE,
design     = "all"
)
install.packages("psidR")
setwd('C:/Users/frost01/Documents/PSIDdata')
#install.packages("readxl")
library(readxl)
#install.packages('psidR')
library(psidR)
#install.packages('devtools')
library(devtools)
#install.packages("data.table")
library(data.table)
years_needed <- unique(fam_vars$year)
fam_year <- psidR::build.panel(
datadir    = psid_dir,
fam.vars   = fam_vars,
ind.vars   = NULL,
heads.only = TRUE,
design     = "all"
)
library(psidR)
years_needed <- unique(fam_vars$year)
fam_year <- psidR::build.panel(
datadir    = psid_dir,
fam.vars   = fam_vars,
ind.vars   = NULL,
heads.only = TRUE,
design     = "all"
)
fam_year <- psidR::build.panel(
datadir    = psid_dir,
fam.vars   = fam_vars,
ind.vars   = NULL,
heads.only = TRUE,
design     = "all"
# some psidR versions also accept: download = TRUE
)
options(psidR.icpsr.user = "samuel.buck@hope.edu")
options(psidR.icpsr.pass = "123Turtles123")
options(psidR.auto.download = TRUE)
fam_year <- psidR::build.panel(
datadir    = psid_dir,
fam.vars   = fam_vars,
ind.vars   = NULL,
heads.only = TRUE,
design     = "all"
)
fam_year <- psidR::build.panel(
datadir    = psid_dir,
fam.vars   = fam_vars,
ind.vars   = NULL,
heads.only = TRUE,
design     = "all"
)
psidR::download_fam(years_needed, datadir = psid_dir)
psid_dir <- normalizePath("C:/Users/frost01/Documents/PSIDdata", winslash="/")
if (!grepl("/$", psid_dir)) psid_dir <- paste0(psid_dir, "/")
dir.create(psid_dir, showWarnings = FALSE, recursive = TRUE)
options(
psidR.icpsr.user = "samuel.buck@hope.edu",     # change
psidR.icpsr.pass = "123Turtles123",  # change (you should rotate this now)
psidR.auto.download = TRUE,
timeout = max(600, getOption("timeout"))
)
fam_year <- psidR::build.panel(
datadir    = psid_dir,
fam.vars   = fam_vars,
ind.vars   = NULL,
heads.only = TRUE,
design     = "all"
)
packageVersion("psidR")
ls("package:psidR")                # see what functions are exported in your version
list.files(psid_dir)               # do any .rda/.RData files exist yet?
list.files("C:/Users/frost01/Documents/PSIDdata", pattern="FAM2017ER")
psid_dir <- "C:/Users/frost01/Documents/PSIDdata/"
for (yr in c( 2017)) {
psidR::build.psid(year = yr, datadir = psid_dir)
}
psidR::build.psid(year = 2017, datadir = psid_dir, syntax = "do")
list.files(psid_dir, pattern = "^FAM2017ER\\.(txt|TXT)$")
list.files(psid_dir, pattern = "^FAM2017ER\\.(do|sps|DO|SPS)$")
psidR::build.psid(
year    = 2017,
datadir = psid_dir,
syntax  = "do",     # or "sps" if you have the SPSS syntax
encoding = "latin1" # often required on Windows for PSID files
(
year    = 2017,
datadir = psid_dir,
syntax  = "do",     # or "sps" if you have the SPSS syntax
encoding = "latin1" # often required on Windows for PSID files
)
psidR::build.psid(
psidR::build.psid(
year    = 2017,
datadir = psid_dir,
syntax  = "do",     # or "sps" if you have the SPSS syntax
encoding = "latin1" # often required on Windows for PSID files
)
psidR::build.psid(years = 2017, where = psid_dir)
psid_dir <- normalizePath("C:/Users/frost01/Documents/PSIDdata", winslash="/")
psidR::build.psid(years = 2017, where = psid_dir)
library(psidR)
psid_dir <- "C:/Users/frost01/Documents/PSIDdata/"
if (!grepl("/$", psid_dir)) psid_dir <- paste0(psid_dir, "/")
# 1) sanity: the raw files must be extracted here with exact stems
stopifnot(
file.exists(file.path(psid_dir, "FAM2017ER.txt")),
file.exists(file.path(psid_dir, "FAM2017ER.do")) ||
file.exists(file.path(psid_dir, "FAM2017ER.sps"))
)
# 2) build the RDA for 2017
psidR::build.psid(years = 2017, where = psid_dir)
library(psidR)
psid_dir <- "C:/Users/frost01/Documents/PSIDdata/"
if (!grepl("/$", psid_dir)) psid_dir <- paste0(psid_dir, "/")
# sanity: files must be EXTRACTED in psid_dir with these exact stems
stopifnot(
file.exists(file.path(psid_dir, "FAM2017ER.txt")),
file.exists(file.path(psid_dir, "FAM2017ER.do")) ||
file.exists(file.path(psid_dir, "FAM2017ER.sps"))
)
# CALL POSITIONALLY (no arg names)
psidR::build.psid(2017, psid_dir)
args(psidR::build.psid)
# or, to see the body:
getAnywhere(build.psid)
dat2017 <- psidR:::read.psid(2017, psid_dir, syntax = "do", encoding = "latin1")
install.packages("remotes")   # only if you don’t already have it
remotes::install_github("floswald/psidR")
library(psidR)
packageVersion("psidR")      # should now show ≥ 2.4
remotes::install_github("floswald/psidR")
packageVersion("psidR")      # should now show ≥ 2.4
remove.packages("psidR")
remotes::install_github(
"floswald/psidR",
force = TRUE,
build_vignettes = FALSE,
dependencies = TRUE
)
